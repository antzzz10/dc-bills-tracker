  name: Monitor DC Bills

  on:
    workflow_dispatch:
    schedule:
      - cron: '0 14 * * *'

  jobs:
    monitor:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Install dependencies
          run: npm install

        - name: Run bill monitoring script
          env:
            CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          run: node scripts/monitor-bills.js > monitoring-report.txt

        - name: Check for changes
          id: check_changes
          run: |
              if [ -f bill-status-history.json ]; then
                LATEST=$(cat bill-status-history.json | jq -r '.[-1].timestamp')
                CHANGES_COUNT=$(cat bill-status-history.json | jq -r '.[-1].changes | length')
                SAFE_TIMESTAMP=$(echo $LATEST | tr ':' '-')
                echo "timestamp=$LATEST" >> $GITHUB_OUTPUT
                echo "safe_timestamp=$SAFE_TIMESTAMP" >> $GITHUB_OUTPUT
                echo "changes_count=$CHANGES_COUNT" >> $GITHUB_OUTPUT
                echo "has_changes=true" >> $GITHUB_OUTPUT
              else
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi

        - name: Upload monitoring report
          if: steps.check_changes.outputs.has_changes == 'true'
          uses: actions/upload-artifact@v4
          with:
              name: monitoring-report-${{ steps.check_changes.outputs.safe_timestamp }}
              path: |
                monitoring-report.txt
                bill-status-history.json
              retention-days: 90

        - name: Commit and push history updates
          if: steps.check_changes.outputs.has_changes == 'true'
          run: |
            git config --global user.name 'DC Bills Monitor'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add bill-status-history.json
            git commit -m "Update bill status history - ${{ steps.check_changes.outputs.timestamp }}" || echo "No changes to commit"
            git push || echo "No changes to push"

        - name: Send email notification
          if: steps.check_changes.outputs.has_changes == 'true' && steps.check_changes.outputs.changes_count > 0
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.gmail.com
            server_port: 587
            username: ${{ secrets.EMAIL_USERNAME }}
            password: ${{ secrets.EMAIL_PASSWORD }}
            subject: "DC Bills Status Update - ${{ steps.check_changes.outputs.changes_count }} bills checked"
            to: ${{ secrets.NOTIFICATION_EMAIL }}
            from: DC Bills Monitor
            body: |
              Bill monitoring completed at ${{ steps.check_changes.outputs.timestamp }}

              Checked ${{ steps.check_changes.outputs.changes_count }} bills for status updates.

              See the attached artifact in GitHub Actions for the full report:
              https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

              View the bill tracker: https://billtracker.representdc.org
